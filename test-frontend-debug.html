<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Debug Test</title>
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .card { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .data-display { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Frontend Debug Test</h1>
    
    <div class="card">
        <h2>Star History Test</h2>
        <div id="star-data" class="data-display">Loading...</div>
        <div id="star-chart"></div>
    </div>

    <div class="card">
        <h2>PR Velocity Test</h2>
        <div id="pr-data" class="data-display">Loading...</div>
        <div id="pr-chart"></div>
    </div>

    <div class="card">
        <h2>Issue Health Test</h2>
        <div id="issue-data" class="data-display">Loading...</div>
        <div id="issue-chart"></div>
    </div>

    <div class="card">
        <h2>Package Downloads Test</h2>
        <div id="package-data" class="data-display">Loading...</div>
        <div id="package-chart"></div>
    </div>

    <script>
        const API_BASE_URL = 'https://v7ka0hnhgg.execute-api.us-east-1.amazonaws.com/prod';

        async function testStarHistory() {
            try {
                console.log('üîÑ Fetching star history...');
                const res = await fetch(`${API_BASE_URL}/api/star-history`);
                const data = await res.json();
                console.log('üìä Star history response:', data);
                
                if (Array.isArray(data)) {
                    const processedData = data.map(d => ({
                        ...d,
                        timestamp: d.timestamp,
                        displayTimestamp: (() => {
                            let dateObj;
                            if (d.timestamp.includes('T') && d.timestamp.includes('Z')) {
                                dateObj = new Date(d.timestamp);
                            } else {
                                dateObj = new Date(d.timestamp.replace(' ', 'T') + 'Z');
                            }
                            return dateObj.toLocaleString(undefined, {
                                year: 'numeric', month: 'long', day: 'numeric',
                                hour: '2-digit', minute: '2-digit', hour12: true
                            });
                        })()
                    }));
                    
                    document.getElementById('star-data').innerHTML = `
                        <div class="success">‚úÖ Star history loaded: ${processedData.length} records</div>
                        <div>Latest count: ${processedData[processedData.length - 1]?.count || 'N/A'}</div>
                        <div>Date range: ${processedData[0]?.displayTimestamp || 'N/A'} to ${processedData[processedData.length - 1]?.displayTimestamp || 'N/A'}</div>
                    `;
                    
                    console.log('üìä Processed star data:', processedData);
                } else {
                    document.getElementById('star-data').innerHTML = `<div class="error">‚ùå No star data array</div>`;
                }
            } catch (error) {
                console.error('üìä Star history error:', error);
                document.getElementById('star-data').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testPrVelocity() {
            try {
                console.log('üìà Fetching PR velocity...');
                const res = await fetch(`${API_BASE_URL}/api/pr-velocity`);
                const data = await res.json();
                console.log('üìà PR velocity response:', data);
                
                if (Array.isArray(data)) {
                    const byDate = {};
                    data.forEach(d => {
                        byDate[d.date] = d;
                    });
                    const sorted = Object.values(byDate).sort((a, b) => a.date.localeCompare(b.date));
                    const chartData = [...sorted.map(d => ({
                        ...d,
                        date: d.date,
                        ratio: d.ratio !== undefined ? Number(d.ratio) : 0
                    }))];
                    
                    document.getElementById('pr-data').innerHTML = `
                        <div class="success">‚úÖ PR velocity loaded: ${chartData.length} records</div>
                        <div>Latest ratio: ${chartData[chartData.length - 1]?.ratio || 'N/A'}</div>
                        <div>Date range: ${chartData[0]?.date || 'N/A'} to ${chartData[chartData.length - 1]?.date || 'N/A'}</div>
                    `;
                    
                    console.log('üìà Processed PR data:', chartData);
                } else {
                    document.getElementById('pr-data').innerHTML = `<div class="error">‚ùå No PR data array</div>`;
                }
            } catch (error) {
                console.error('üìà PR velocity error:', error);
                document.getElementById('pr-data').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testIssueHealth() {
            try {
                console.log('üêõ Fetching issue health...');
                const res = await fetch(`${API_BASE_URL}/api/issue-health`);
                const data = await res.json();
                console.log('üêõ Issue health response:', data);
                
                if (Array.isArray(data)) {
                    const byDate = {};
                    data.forEach(d => {
                        byDate[d.date] = d;
                    });
                    const sorted = Object.values(byDate).sort((a, b) => a.date.localeCompare(b.date));
                    const chartData = [...sorted.map(d => ({
                        ...d,
                        date: d.date,
                        ratio: d.ratio !== undefined ? Number(d.ratio) : 0
                    }))];
                    
                    document.getElementById('issue-data').innerHTML = `
                        <div class="success">‚úÖ Issue health loaded: ${chartData.length} records</div>
                        <div>Latest ratio: ${chartData[chartData.length - 1]?.ratio || 'N/A'}</div>
                        <div>Date range: ${chartData[0]?.date || 'N/A'} to ${chartData[chartData.length - 1]?.date || 'N/A'}</div>
                    `;
                    
                    console.log('üêõ Processed issue data:', chartData);
                } else {
                    document.getElementById('issue-data').innerHTML = `<div class="error">‚ùå No issue data array</div>`;
                }
            } catch (error) {
                console.error('üêõ Issue health error:', error);
                document.getElementById('issue-data').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testPackageDownloads() {
            try {
                console.log('üì¶ Fetching package downloads...');
                const res = await fetch(`${API_BASE_URL}/api/package-downloads`);
                const data = await res.json();
                console.log('üì¶ Package downloads response:', data);
                
                if (Array.isArray(data)) {
                    const byWeek = {};
                    data.forEach(d => {
                        byWeek[d.week_start] = d;
                    });
                    const sorted = Object.values(byWeek).sort((a, b) => a.week_start.localeCompare(b.week_start));
                    const chartData = [...sorted.map(d => ({
                        ...d,
                        week_start: d.week_start,
                        downloads: d.downloads !== undefined ? Number(d.downloads) : 0
                    }))];
                    
                    document.getElementById('package-data').innerHTML = `
                        <div class="success">‚úÖ Package downloads loaded: ${chartData.length} records</div>
                        <div>Latest downloads: ${chartData[chartData.length - 1]?.downloads || 'N/A'}</div>
                        <div>Week range: ${chartData[0]?.week_start || 'N/A'} to ${chartData[chartData.length - 1]?.week_start || 'N/A'}</div>
                    `;
                    
                    console.log('üì¶ Processed package data:', chartData);
                } else {
                    document.getElementById('package-data').innerHTML = `<div class="error">‚ùå No package data array</div>`;
                }
            } catch (error) {
                console.error('üì¶ Package downloads error:', error);
                document.getElementById('package-data').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Run all tests
        async function runAllTests() {
            console.log('üß™ Starting frontend debug tests...');
            await testStarHistory();
            await testPrVelocity();
            await testIssueHealth();
            await testPackageDownloads();
            console.log('‚úÖ All tests completed!');
        }

        runAllTests();
    </script>
</body>
</html> 